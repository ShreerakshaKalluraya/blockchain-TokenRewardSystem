<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dashboard - Loyalty Rewards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f5f5f5; }
        .sidebar { background-color: #343a40; color: white; height: 100vh; position: fixed; }
        .sidebar .nav-link { color: rgba(255,255,255,.5); }
        .sidebar .nav-link.active { color: white; background-color: rgba(255,255,255,.1); }
        .sidebar .nav-link:hover { color: rgba(255,255,255,.75); }
        .main-content { margin-left: 250px; padding: 20px; }
        .stat-card { border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .stat-card .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-card .stat-label { color: #6c757d; }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 250px;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <span class="fs-4">Business Dashboard</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" class="nav-link active" id="dashboardTab">
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" id="customersTab">
                        Customers
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" id="rewardsTab">
                        Reward Settings
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" id="promotionsTab">
                        Promotions
                    </a>
                </li>
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown">
                    <span id="businessWalletAddress">Not Connected</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item" href="#" id="disconnectBtn">Disconnect</a></li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <h2>Dashboard Overview</h2>
            
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="stat-card bg-white">
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card bg-white">
                        <div class="stat-value" id="pointsIssued">0</div>
                        <div class="stat-label">Points Issued</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card bg-white">
                        <div class="stat-value" id="pointsRedeemed">0</div>
                        <div class="stat-label">Points Redeemed</div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            Reward Activity (Last 30 Days)
                        </div>
                        <div class="card-body">
                            <canvas id="activityChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Quick Actions
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary w-100 mb-2" id="issuePointsBtn">Issue Points</button>
                            <button class="btn btn-outline-primary w-100 mb-2" id="createPromoBtn">Create Promotion</button>
                            <button class="btn btn-outline-secondary w-100" id="viewReportsBtn">View Reports</button>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            Recent Activity
                        </div>
                        <div class="card-body">
                            <div id="recentActivity">
                                <p>Loading activity...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Points Modal -->
    <div class="modal fade" id="issuePointsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Issue Reward Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Customer Wallet Address</label>
                        <input type="text" class="form-control" id="customerAddress">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Points Amount</label>
                        <input type="number" class="form-control" id="pointsAmount">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason (Optional)</label>
                        <input type="text" class="form-control" id="pointsReason">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmIssueBtn">Issue Points</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // Global variables
        let web3;
        let contract;
        let account;
        let activityChart;
        
        // Contract ABI (simplified example for business dashboard)
        const contractABI = [
            {
                "constant": false,
                "inputs": [
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "issuePoints",
                "outputs": [{"name": "success", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_business", "type": "address"}],
                "name": "getBusinessStats",
                "outputs": [
                    {"name": "totalCustomers", "type": "uint256"},
                    {"name": "pointsIssued", "type": "uint256"},
                    {"name": "pointsRedeemed", "type": "uint256"}
                ],
                "type": "function"
            }
        ];
        
        // Contract address (replace with your actual contract address)
        const contractAddress = "0x123...abc"; 
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                // Try to connect automatically
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        account = accounts[0];
                        initializeDashboard();
                    } else {
                        // Request connection
                        await connectWallet();
                    }
                } catch (error) {
                    console.error("Error connecting to MetaMask:", error);
                }
                
                // Set up event listeners
                document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
                document.getElementById('issuePointsBtn').addEventListener('click', () => {
                    const modal = new bootstrap.Modal(document.getElementById('issuePointsModal'));
                    modal.show();
                });
                document.getElementById('confirmIssueBtn').addEventListener('click', issuePoints);
                
                // Initialize chart
                initActivityChart();
            } else {
                alert('Please install MetaMask to use the business dashboard!');
            }
        });
        
        // Connect wallet function
        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                document.getElementById('businessWalletAddress').textContent = account.substring(0, 6) + '...' + account.substring(38);
                
                initializeDashboard();
            } catch (error) {
                console.error("Error connecting wallet:", error);
            }
        }
        
        // Disconnect wallet
        function disconnectWallet() {
            account = null;
            window.location.reload();
        }
        
        // Initialize the dashboard
        async function initializeDashboard() {
            // Load contract
            contract = new web3.eth.Contract(contractABI, contractAddress);
            
            // Load business stats
            loadBusinessStats();
            
            // Load recent activity
            loadRecentActivity();
            
            // Listen for account changes
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // Wallet disconnected
                    disconnectWallet();
                } else {
                    // Account changed
                    account = accounts[0];
                    document.getElementById('businessWalletAddress').textContent = account.substring(0, 6) + '...' + account.substring(38);
                    initializeDashboard();
                }
            });
        }
        
        // Load business statistics
        async function loadBusinessStats() {
            try {
                const stats = await contract.methods.getBusinessStats(account).call();
                document.getElementById('totalCustomers').textContent = stats.totalCustomers;
                document.getElementById('pointsIssued').textContent = stats.pointsIssued;
                document.getElementById('pointsRedeemed').textContent = stats.pointsRedeemed;
            } catch (error) {
                console.error("Error loading business stats:", error);
            }
        }
        
        // Load recent activity
        async function loadRecentActivity() {
            // In a real app, you would fetch this from your backend API
            const mockActivity = [
                { id: 1, date: '2023-06-15 14:30', action: 'Issued 50 points to customer 0x123...456' },
                { id: 2, date: '2023-06-14 11:15', action: 'Customer 0x789...abc redeemed 30 points' },
                { id: 3, date: '2023-06-12 09:45', action: 'Issued 120 points to customer 0xdef...123' },
                { id: 4, date: '2023-06-10 16:20', action: 'Updated reward rules' }
            ];
            
            const activityElement = document.getElementById('recentActivity');
            activityElement.innerHTML = '';
            
            if (mockActivity.length === 0) {
                activityElement.innerHTML = '<p>No recent activity found.</p>';
                return;
            }
            
            mockActivity.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'mb-2';
                activityItem.innerHTML = `
                    <small class="text-muted">${activity.date}</small>
                    <div>${activity.action}</div>
                `;
                activityElement.appendChild(activityItem);
            });
        }
        
        // Initialize activity chart
        function initActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Mock data - in a real app, fetch from your backend
            const labels = Array.from({length: 30}, (_, i) => `${i+1} Jun`);
            const issuedData = labels.map(() => Math.floor(Math.random() * 100));
            const redeemedData = labels.map(() => Math.floor(Math.random() * 50));
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Points Issued',
                            data: issuedData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Points Redeemed',
                            data: redeemedData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Issue points to a customer
        async function issuePoints() {
            const customerAddress = document.getElementById('customerAddress').value;
            const pointsAmount = document.getElementById('pointsAmount').value;
            const reason = document.getElementById('pointsReason').value;
            
            if (!web3.utils.isAddress(customerAddress)) {
                alert('Please enter a valid wallet address');
                return;
            }
            
            if (!pointsAmount || pointsAmount <= 0) {
                alert('Please enter a valid points amount');
                return;
            }
            
            try {
                document.getElementById('confirmIssueBtn').disabled = true;
                document.getElementById('confirmIssueBtn').textContent = 'Processing...';
                
                // Call issuePoints function on the smart contract
                await contract.methods.issuePoints(customerAddress, pointsAmount).send({ from: account });
                
                alert('Points issued successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('issuePointsModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('customerAddress').value = '';
                document.getElementById('pointsAmount').value = '';
                document.getElementById('pointsReason').value = '';
                
                // Refresh data
                loadBusinessStats();
                loadRecentActivity();
            } catch (error) {
                console.error("Error issuing points:", error);
                alert('Failed to issue points: ' + error.message);
            } finally {
                document.getElementById('confirmIssueBtn').disabled = false;
                document.getElementById('confirmIssueBtn').textContent = 'Issue Points';
            }
        }
    </script>
</body>
</html>